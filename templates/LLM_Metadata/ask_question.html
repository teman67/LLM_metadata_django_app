{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container mt-3">
    <h2 class="text-center text-primary">Ask a Question</h2>

    <!-- Display error messages -->
    {% if messages %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        {% for message in messages %}
        {% if message.tags == "error" %}
        <p>{{ message }}</p>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Toggle Button for Question Form -->
    <div class="text-center mb-3">
        <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#questionForm"
            aria-expanded="true" aria-controls="questionForm">
            Hide Question Form
        </button>
    </div>

    <!-- Question Form Section -->
    <!-- Question Form Section -->
    <div class="collapse show" id="questionForm">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <form method="POST" class="mb-4 border p-4 rounded shadow-sm bg-light">
                    {% csrf_token %}

                    <!-- Question Input in its own row -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            {{ form.question.label_tag }}
                            {{ form.question|add_class:"form-control" }}
                            <!-- <small class="form-text text-muted">Type your question here.</small> -->
                        </div>
                    </div>

                    <!-- Other inputs in a single row -->
                    <div class="row">
                        <div class="col-md-2">
                            {{ form.model.label_tag }}
                            {{ form.model|add_class:"form-select" }}
                            <!-- <small class="form-text text-muted">Choose the LLM model.</small> -->
                        </div>
                        <div class="col-md-2">
                            {{ form.max_tokens.label_tag }}
                            {{ form.max_tokens|add_class:"form-control" }}
                            <!-- <small class="form-text text-muted">Max Tokens</small> -->
                        </div>
                        <div class="col-md-2">
                            {{ form.temperature.label_tag }}
                            {{ form.temperature|add_class:"form-control" }}
                            <!-- <small class="form-text text-muted">Temperature</small> -->
                        </div>
                        <div class="col-md-2">
                            {{ form.top_k.label_tag }}
                            {{ form.top_k|add_class:"form-control" }}
                            <!-- <small class="form-text text-muted">Top K</small> -->
                        </div>
                        <div class="col-md-2">
                            {{ form.top_p.label_tag }}
                            {{ form.top_p|add_class:"form-control" }}
                            <!-- <small class="form-text text-muted">Top P</small> -->
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-primary">Submit Question</button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <!-- Toggle Button for Conversation History -->
    <div class="text-center mb-3">
        <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#conversationHistory"
            aria-expanded="true" aria-controls="conversationHistory">
            Hide Conversation History
        </button>
    </div>

    <!-- Conversation History Section -->
    <div class="collapse show" id="conversationHistory">
        <h3 class="text-center text-secondary mt-4">Current Conversation</h3>
        <div class="conversation-history border p-3 rounded bg-light">
            {% if conversations %}
                {% for conversation in conversations %}
                    <div class="conversation-item mb-2">
                        <p><strong>{{ conversation.role|capfirst }}:</strong> {{ conversation.content }}</p>
                        <p class="text-muted small">
                            Model: {{ conversation.model_name }} | 
                            Tokens: {{ conversation.token_usage }} | 
                            Time: {{ conversation.elapsed_time }}s
                        </p>
                    </div>
                    <hr>
                {% endfor %}
            {% else %}
                <p class="text-muted">No conversation started yet.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Toggle button for question form
    document.querySelector('[data-bs-toggle="collapse"][data-bs-target="#questionForm"]').addEventListener('click', function () {
        this.textContent = this.getAttribute('aria-expanded') === 'true' ? 'Hide Question Form' : 'Show Question Form';
    });

    // Toggle button for conversation history
    document.querySelector('[data-bs-toggle="collapse"][data-bs-target="#conversationHistory"]').addEventListener('click', function () {
        this.textContent = this.getAttribute('aria-expanded') === 'true' ? 'Hide Conversation History' : 'Show Conversation History';
    });
</script>

{% endblock %}